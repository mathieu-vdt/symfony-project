<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>{% block title %}Welcome!{% endblock %}</title>
        <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 128 128%22><text y=%221.2em%22 font-size=%2296%22>⚫️</text><text y=%221.3em%22 x=%220.2em%22 font-size=%2276%22 fill=%22%23fff%22>sf</text></svg>">
        {% block stylesheets %}
            {{ encore_entry_link_tags('app') }}
        {% endblock %}

        {% block javascripts %}
            {{ encore_entry_script_tags('app') }}
        {% endblock %}
    </head>
    <body>
        <div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>

        {# ================= NAVBAR ================= #}
        <nav class="bg-white/90 backdrop-blur border-b border-zinc-200">
        <div class="container mx-auto px-4">
            <div class="flex h-14 items-center justify-between">
            {# Left: Brand + desktop links #}
            <div class="flex items-center gap-6">
                <a href="{{ path('app_home') }}" class="flex items-center gap-2">
                <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-indigo-600 text-white font-bold">CB</span>
                <span class="font-semibold text-zinc-800">Cookbook</span>
                </a>

                <div class="hidden md:flex items-center gap-4">
                {% if app.user %}
                    <a href="{{ path('app_recipe_mine') }}"
                        class="rounded-xl px-3 py-2 text-sm font-medium {{ mine|default(false) ? 'bg-indigo-600 text-white' : 'border border-zinc-300 text-zinc-700 hover:bg-zinc-50' }}">
                        My recipes
                    </a>
                    {% endif %}
                    <a href="{{ path('app_home') }}"
                    class="rounded-xl px-3 py-2 text-sm font-medium {{ mine|default(false) ? 'border border-zinc-300 text-zinc-700 hover:bg-zinc-50' : 'bg-indigo-600 text-white' }}">
                    All
                    </a>

                {% if app.user %}
                    <a href="{{ path('app_recipe_new') }}"
                    class="inline-flex items-center gap-2 rounded-lg bg-indigo-600 px-3 py-1.5 text-sm font-medium text-white hover:bg-indigo-700">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="h-4 w-4">
                        <path d="M12 5v14M5 12h14"/>
                    </svg>
                    New Recipe
                    </a>
                {% endif %}
                </div>
            </div>

            {# Right: Auth area (desktop) #}
            <div class="hidden md:flex items-center gap-3">
                {% if app.user %}
                <span class="hidden lg:inline text-sm text-zinc-600">Signed in as <strong class="text-zinc-800">{{ app.user.username }}</strong></span>

                {# Avatar + dropdown #}
                <div class="relative" x-data="{ open:false }">
                    <button type="button"
                            class="flex items-center gap-2 rounded-full px-2 py-1 hover:bg-zinc-100"
                            aria-haspopup="menu"
                            aria-expanded="false"
                            onclick="this.nextElementSibling.classList.toggle('hidden')">
                    <span class="h-8 w-8 rounded-full bg-indigo-600 text-white text-sm font-semibold grid place-items-center">
                        {{ app.user.username|slice(0,1)|upper }}
                    </span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-zinc-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd" />
                    </svg>
                    </button>
                    <div class="absolute right-0 mt-2 w-44 rounded-xl border border-zinc-200 bg-white p-1 shadow-lg hidden z-50"
                        role="menu">
                    <a href="{{ path('app_home') }}"
                        class="block rounded-lg px-3 py-2 text-sm text-zinc-700 hover:bg-zinc-100"
                        role="menuitem">Dashboard</a>
                    
                    {% if is_granted('ROLE_ADMIN') %}
                        <a href="{{ path('admin_dashboard') }}"
                        class="block rounded-lg px-3 py-2 text-sm text-indigo-700 hover:bg-indigo-50"
                        role="menuitem">Admin</a>
                    {% endif %}


                    <form method="post" action="{{ path('app_logout') }}" class="block" role="menuitem">
                        <button class="w-full text-left rounded-lg px-3 py-2 text-sm text-red-700 hover:bg-red-50">
                        Logout
                        </button>
                    </form>
                    </div>
                </div>
                {% else %}
                <a href="{{ path('app_login') }}"
                    class="rounded-lg px-3 py-1.5 text-sm font-medium text-zinc-700 hover:bg-zinc-100">
                    Login
                </a>
                <a href="{{ path('app_register') }}"
                    class="inline-flex items-center gap-2 rounded-lg bg-indigo-600 px-3 py-1.5 text-sm font-medium text-white hover:bg-indigo-700">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="h-4 w-4">
                    <path d="M12 5v14M5 12h14"/>
                    </svg>
                    Register
                </a>
                {% endif %}
            </div>

            {# Mobile menu button #}
            <button class="md:hidden inline-flex items-center justify-center rounded-lg p-2 text-zinc-600 hover:bg-zinc-100"
                    aria-label="Open menu"
                    onclick="document.getElementById('mobile-menu').classList.toggle('hidden')">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                        d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>
            </div>
        </div>

        {# Mobile menu #}
        <div id="mobile-menu" class="md:hidden hidden border-t border-zinc-200 bg-white">
            <div class="container mx-auto px-4 py-3 space-y-2">
            <a href="{{ path('app_home') }}"
                class="block rounded-lg px-3 py-2 text-sm text-zinc-700 hover:bg-zinc-100">
                Recipes
            </a>

            {% if app.user %}
                <a href="{{ path('app_recipe_new') }}"
                class="block rounded-lg px-3 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                New Recipe
                </a>
                {% if is_granted('ROLE_ADMIN') %}
                <a href="{{ path('admin_dashboard') }}"
                    class="block rounded-lg px-3 py-2 text-sm font-medium text-indigo-700 bg-indigo-50 hover:bg-indigo-100">
                    Admin
                </a>
                {% endif %}
                <div class="flex items-center justify-between rounded-lg px-3 py-2 bg-zinc-50">
                <span class="text-sm text-zinc-600">Signed in as <strong class="text-zinc-800">{{ app.user.username }}</strong></span>
                <form method="post" action="{{ path('app_logout') }}">
                    <button class="ml-3 text-sm text-red-700 hover:text-red-800">Logout</button>
                </form>
                </div>
            {% else %}
                <a href="{{ path('app_login') }}"
                class="block rounded-lg px-3 py-2 text-sm text-zinc-700 hover:bg-zinc-100">
                Login
                </a>
                <a href="{{ path('app_register') }}"
                class="block rounded-lg px-3 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                Register
                </a>
            {% endif %}
            </div>
        </div>
        </nav>
        {# =============== END NAVBAR =============== #}


        {# Serialize flashes as <template> data so we don't "consume" them elsewhere #}
        {% for type, messages in app.flashes %}
            {% for message in messages %}
            <template class="toast-data"
                        data-type="{{ type }}"
                        data-message="{{ message|e('html_attr') }}"></template>
            {% endfor %}
        {% endfor %}

        {% block body %}{% endblock %}

        {# Toast JS (runs on DOMContentLoaded and turbo:load) #}
        <script>
            function createToast(message, type = 'info') {
            const el = document.createElement('div');
            el.className = "pointer-events-auto w-72 max-w-sm rounded-xl px-4 py-3 shadow-lg text-sm animate-slide-in " +
                (type === 'success' ? "bg-emerald-50 text-emerald-700 border border-emerald-200"
                : type === 'error' || type === 'danger' ? "bg-red-50 text-red-700 border border-red-200"
                : type === 'warning' ? "bg-amber-50 text-amber-700 border border-amber-200"
                : "bg-zinc-50 text-zinc-700 border border-zinc-200");

            el.innerHTML = `
                <div class="flex justify-between items-start gap-3">
                <div class="flex-1">${message}</div>
                <button class="text-zinc-400 hover:text-zinc-600" aria-label="Fermer"
                        onclick="this.closest('div').remove()">✕</button>
                </div>
            `;
            const container = document.getElementById('toast-container');
            container?.appendChild(el);
            setTimeout(() => {
                el.classList.add('opacity-0','transition','duration-500');
                setTimeout(() => el.remove(), 500);
            }, 4000);
            }

            (function mountToastsOncePerVisit(){
            function run() {
                document.querySelectorAll('template.toast-data').forEach(tpl => {
                createToast(tpl.dataset.message, tpl.dataset.type);
                tpl.remove(); // avoid re-showing on subsequent turbo renders
                });
            }
            document.addEventListener('DOMContentLoaded', run);
            document.addEventListener('turbo:load', run); // works if Turbo enabled
            })();

            // Tiny keyframe animation
            document.head.insertAdjacentHTML('beforeend', `
            <style>
                @keyframes slide-in { from { transform: translateX(100%); opacity: 0 }
                                    to   { transform: translateX(0);    opacity: 1 } }
                .animate-slide-in { animation: slide-in .25s ease-out }
            </style>
            `);
        </script>
    </body>
</html>
