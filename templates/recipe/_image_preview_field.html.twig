{# Reusable for create/edit #}
{% set inputId   = form.imageFile.file.vars.id %}
{% set previewId = inputId ~ '_preview' %}

<div class="space-y-2">
  {{ form_label(form.imageFile.file, 'Image', { label_attr: { class: 'block text-sm font-medium' } }) }}

  <div class="flex items-center gap-4">
    {{ form_widget(form.imageFile.file, {
      attr: {
        id: inputId,
        accept: 'image/*',
        class: 'block w-full text-sm text-zinc-700 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100'
      }
    }) }}

    <img id="{{ previewId }}"
         src="{% if recipe is defined and recipe.imageName %}{{ vich_uploader_asset(recipe, 'imageFile') }}{% endif %}"
         alt="Preview"
         class="h-16 w-16 rounded-lg object-cover ring-1 ring-zinc-200 {% if not (recipe is defined and recipe.imageName) %}hidden{% endif %}">
  </div>

  {# Optional: "Delete image" checkbox if Vich renders it #}
  {% if form.imageFile.delete is defined %}
    <div class="flex items-center gap-2">
      {{ form_widget(form.imageFile.delete) }}
      {{ form_label(form.imageFile.delete, 'Delete image', { label_attr: { class: 'text-xs text-zinc-600' } }) }}
    </div>
  {% endif %}

  {{ form_errors(form.imageFile.file) }}
</div>

{# Local script attached to this field #}
<script>
(function() {
  const input   = document.getElementById('{{ inputId }}');
  const preview = document.getElementById('{{ previewId }}');
  if (!input || !preview) return;

  input.addEventListener('change', function () {
    const file = this.files && this.files[0];
    if (!file) {
      preview.src = '';
      preview.classList.add('hidden');
      return;
    }
    const url = URL.createObjectURL(file);
    preview.src = url;
    preview.classList.remove('hidden');
    preview.onload = () => URL.revokeObjectURL(url);

    // If Vich renders the delete checkbox, uncheck it when a new file is chosen
    const deleteName = this.name.replace('[file]', '[delete]');
    const del = document.querySelector(`[name="${CSS.escape(deleteName)}"]`);
    if (del) del.checked = false;
  });
})();
</script>
